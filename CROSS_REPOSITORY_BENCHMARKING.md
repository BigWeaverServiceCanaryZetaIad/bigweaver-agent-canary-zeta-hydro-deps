# Cross-Repository Benchmarking Guide

## Overview

This guide explains how to run performance comparisons across the two repositories:
- **bigweaver-agent-canary-hydro-zeta** (main repository) - Hydro-native DFIR implementations
- **bigweaver-agent-canary-zeta-hydro-deps** (this repository) - Timely/Differential-Dataflow comparison implementations

## Repository Architecture

The benchmark suite is split across two repositories to achieve:
1. **Reduced dependencies** in the main repository for faster builds
2. **Independent evolution** of Hydro-native and comparison implementations
3. **Fair performance comparison** by maintaining identical benchmark structures
4. **Clear separation** between core implementations and external dependencies

## Benchmark Structure

Each benchmark exists in both repositories:

### In bigweaver-agent-canary-hydro-zeta (Main Repository)
- Contains Hydro-native DFIR implementations
- Uses `dfir_rs` for dataflow operations
- No timely or differential-dataflow dependencies
- Fast builds, focused on core development

### In bigweaver-agent-canary-zeta-hydro-deps (This Repository)
- Contains or will contain timely/differential-dataflow implementations
- Currently includes Hydro-native versions as templates
- Ready for adding comparison implementations
- Includes timely and differential-dataflow dependencies

## Running Performance Comparisons

### Step 1: Set Up Both Repositories

```bash
# Clone the main repository
git clone https://github.com/BigWeaverServiceCanaryZetaIad/bigweaver-agent-canary-hydro-zeta.git

# Clone the deps repository
git clone https://github.com/BigWeaverServiceCanaryZetaIad/bigweaver-agent-canary-zeta-hydro-deps.git
```

### Step 2: Run Hydro-Native Benchmarks

```bash
cd bigweaver-agent-canary-hydro-zeta
cargo bench -p benches
```

This will:
- Build the Hydro-native implementations
- Run all benchmarks using DFIR
- Save results to `target/criterion/`
- Generate HTML reports in `target/criterion/report/`

### Step 3: Run Timely/Differential-Dataflow Benchmarks

```bash
cd bigweaver-agent-canary-zeta-hydro-deps
cargo bench -p benches
```

This will:
- Build with timely/differential-dataflow dependencies
- Run comparison implementations
- Save results to `target/criterion/`
- Generate HTML reports in `target/criterion/report/`

### Step 4: Compare Results

#### Using Criterion HTML Reports
1. Open the HTML reports generated by Criterion in each repository
2. Compare metrics such as:
   - Mean execution time
   - Standard deviation
   - Throughput measurements
   - Performance variance

#### Using Criterion's Comparison Mode
```bash
# In either repository, after running benchmarks
cargo bench -p benches -- --save-baseline baseline_name

# After making changes or running the other implementation
cargo bench -p benches -- --baseline baseline_name
```

#### Manual Comparison
Export and compare the raw data:
```bash
# From each repository
find target/criterion -name "base" -type d
```

## Available Benchmarks

All benchmarks are available in both repositories:

| Benchmark | Description | Test Data |
|-----------|-------------|-----------|
| **micro_ops** | Micro-operations testing basic dataflow primitives (identity, unique, map, filter, fold, etc.) | Random integer data |
| **symmetric_hash_join** | Symmetric hash join implementation | Random join data |
| **words_diamond** | Word processing with diamond-shaped dataflow pattern | words_alpha.txt |
| **futures** | Futures-based asynchronous operations | Generated data |

## Adding New Benchmarks

To add a new benchmark for comparison:

### 1. Create in Main Repository First
```bash
cd bigweaver-agent-canary-hydro-zeta/benches/benches
# Create your_benchmark.rs with Hydro-native implementation
```

### 2. Add to Main Repository Cargo.toml
```toml
[[bench]]
name = "your_benchmark"
harness = false
```

### 3. Copy to Deps Repository
```bash
cp bigweaver-agent-canary-hydro-zeta/benches/benches/your_benchmark.rs \
   bigweaver-agent-canary-zeta-hydro-deps/benches/benches/
```

### 4. Add to Deps Repository Cargo.toml
```toml
[[bench]]
name = "your_benchmark"
harness = false
```

### 5. Implement Timely/Differential Version
Edit the copied file in the deps repository to add timely/differential-dataflow implementations alongside or replacing the Hydro-native version.

### 6. Document Both Implementations
Update README files in both repositories to describe:
- What the benchmark measures
- Any test data requirements
- Expected performance characteristics
- How to interpret results

## Best Practices

### Ensuring Fair Comparisons
1. **Use identical test data** - Copy data files to both repositories
2. **Use equivalent parameters** - Same data sizes, iteration counts, etc.
3. **Run under similar conditions** - Same hardware, avoid background processes
4. **Multiple runs** - Criterion automatically handles this, but be aware of variance
5. **Document differences** - Note any algorithmic differences that affect comparison

### Managing Dependencies
- **Main repository**: Keep dependency-free for fast development
- **Deps repository**: Include only necessary comparison dependencies
- **Sync regularly**: Keep benchmark structures aligned between repositories

### Version Control
- **Tag releases**: Tag both repositories at comparison points
- **Document versions**: Note which versions were compared in results
- **Track changes**: Document any benchmark modifications in both places

## Troubleshooting

### Different Results Between Repositories
- Verify identical test data
- Check for algorithmic differences
- Ensure same Criterion version
- Compare debug vs release builds

### Build Issues
- **Main repository**: Should build without network access to external crates
- **Deps repository**: Requires network access for timely/differential crates
- Check Rust version compatibility

### Performance Variance
- Run benchmarks multiple times
- Check for system background processes
- Ensure consistent CPU governor settings
- Use `--sample-size` flag for more samples if needed

## Repository Links

- **Main Repository**: https://github.com/BigWeaverServiceCanaryZetaIad/bigweaver-agent-canary-hydro-zeta
- **Deps Repository**: https://github.com/BigWeaverServiceCanaryZetaIad/bigweaver-agent-canary-zeta-hydro-deps

## Further Reading

- [Criterion.rs Documentation](https://bheisler.github.io/criterion.rs/book/)
- [Timely Dataflow Documentation](https://github.com/TimelyDataflow/timely-dataflow)
- [Differential Dataflow Documentation](https://github.com/TimelyDataflow/differential-dataflow)

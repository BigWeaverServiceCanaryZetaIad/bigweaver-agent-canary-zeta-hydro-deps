# Hydro Microbenchmarks

Performance benchmarks for Hydro comparing implementations using dfir_rs, timely, and differential-dataflow.

## Overview

This benchmark suite provides comprehensive performance comparisons across different dataflow frameworks:
- **Hydro (dfir_rs)**: Hydro's native dataflow implementation
- **Timely Dataflow**: Low-latency dataflow framework
- **Differential Dataflow**: Incremental computation framework

## Benchmark Descriptions

### Basic Operations

- **identity**: Measures the overhead of the identity operation (pass-through)
- **arithmetic**: Tests basic arithmetic operations in a pipeline
- **upcase**: String transformation benchmark (uppercase conversion)

### Data Flow Patterns

- **fan_in**: Multiple input streams merging into one
- **fan_out**: Single stream splitting into multiple outputs  
- **fork_join**: Split processing paths that rejoin
- **words_diamond**: Diamond-shaped dataflow pattern with word processing

### Join Operations

- **join**: Standard join operation benchmark
- **symmetric_hash_join**: Symmetric hash join implementation comparison
- **reachability**: Graph reachability computation using joins

### Advanced Operations

- **micro_ops**: Collection of micro-operations testing individual operators
- **futures**: Async/await futures integration benchmark

## Running Benchmarks

### Run All Benchmarks

```bash
cargo bench -p benches
```

### Run Specific Benchmark

```bash
cargo bench -p benches --bench reachability
cargo bench -p benches --bench join
```

### Run with Specific Configuration

```bash
# Run with verbose output
cargo bench -p benches --bench reachability -- --verbose

# Run specific test within a benchmark
cargo bench -p benches --bench micro_ops -- filter

# Save baseline for comparison
cargo bench -p benches -- --save-baseline baseline_name
```

## Benchmark Data Files

### reachability_edges.txt
Graph edge data for the reachability benchmark. Format: source vertex, destination vertex pairs.

### reachability_reachable.txt  
Expected reachable vertices for validation of the reachability benchmark results.

### words_alpha.txt
English word list for text processing benchmarks. 
Source: https://github.com/dwyl/english-words/blob/master/words_alpha.txt

## Generated Files

### fork_join_20.hf
Automatically generated by `build.rs` during compilation. Contains the dataflow graph definition for the fork-join benchmark with 20 operations.

## Benchmark Output

Criterion generates detailed reports in `target/criterion/`:
- HTML reports with graphs and statistical analysis
- CSV data for further analysis
- Historical comparison data

## Interpreting Results

Each benchmark reports:
- **Time**: Mean execution time with confidence intervals
- **Throughput**: Operations per second
- **Change**: Performance change vs. previous run (if available)

Example output:
```
reachability/dfir        time:   [45.234 ms 45.789 ms 46.421 ms]
                         thrpt:  [21.532 Kelem/s 21.836 Kelem/s 22.103 Kelem/s]
```

## Adding New Benchmarks

To add a new benchmark:

1. Create a new `.rs` file in `benches/benches/`
2. Add a `[[bench]]` entry in `Cargo.toml`:
   ```toml
   [[bench]]
   name = "my_benchmark"
   harness = false
   ```
3. Use the criterion framework for consistent benchmarking
4. Include comparisons across dfir_rs, timely, and differential-dataflow when applicable

## Development

### Check Compilation

```bash
cargo check -p benches
```

### Build Without Running

```bash
cargo build -p benches --benches
```

## Performance Tips

- Run benchmarks on a quiet system (minimal background processes)
- Use release builds (criterion does this by default)
- Run multiple iterations for statistical significance
- Consider CPU frequency scaling and thermal throttling
- Use `--save-baseline` to track performance over time

## Dependencies

Key dependencies for benchmarking:
- **criterion**: Benchmarking framework with statistical analysis
- **timely-master**: Timely dataflow framework
- **differential-dataflow-master**: Differential dataflow framework  
- **dfir_rs**: Hydro's dataflow IR (from main repository)
- **tokio**: Async runtime for futures benchmarks
